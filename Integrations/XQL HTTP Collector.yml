commonfields:
  id: XQL HTTP Collector_v2
  version: -1
vcShouldKeepItemLegacyProdMachine: false
name: XQL HTTP Collector_v2
display: XQL HTTP Collector_v2
category: Utilities
image: data:image/png;base64,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
description: This integration allows for posting data to the XSIAM HTTP collector
  so it can be queried via XQL
detaileddescription: "Used for posted to HTTP data set in XSIAM. Use the standard
  API key for this one. \n\nCorrelation rule can then be created to generate alerts
  based on the data generated from this command.\n\nNOTE: Test button was never implemented
  so...."
configuration:
- section: Connect
  advanced: true
  display: Trust any certificate (not secure)
  name: insecure
  type: 8
  required: false
- section: Connect
  advanced: true
  display: Use system proxy settings
  name: proxy
  type: 8
  required: false
- display: ""
  name: token
  type: 4
  required: true
- display: ""
  name: url
  type: 0
  required: false
  additionalinfo: 'Optional: If left empty the integration will default to the current
    tenant'
script:
  script: |
    register_module_line('XQLHTTPCollector', 'start', __line__())


    def main() -> None:
        """
        main function, parses params and runs command functions
        """

        params = demisto.params()
        args = demisto.args()
        command = demisto.command()

        api_key = params.get('credentials', {}).get('password')

        # get the service API url
        base_url = urljoin(params.get('url'), '/api/v1')


        verify_certificate = not params.get('insecure', False)

        proxy = params.get('proxy', False)


        demisto.debug(f'Command being called is {command}')
        try:
            headers = {
                'Authorization': f'{api_key}',
            }

            if command in ['xql-post-to-dataset', 'test-module']:
                Token = params.get("token")

                URL = params.get('url') or demisto.demistoUrls()['server'].replace('https://', 'https://api-') + '/logs/v1/event'

                headers = {
                    "Authorization": Token,
                    "Content-Type": "text/plain"
                }

                if command == 'test_module':
                    data = {"test": "test"}
                else:
                    data = demisto.args().get("JSON")

                try:
                    if not isinstance(data, list): data = [data]
                    for each in data:
                        res = requests.post(URL, headers=headers, json=each, verify=False)


                    if (res.status_code != 200):
                        return_error(f"{res.status_code}: {res}")

                except:
                    res = requests.post(URL, headers=headers, data=data, verify=False)

                    if (res.status_code != 200):
                        return_error(f"{res.status_code}: {res}")

                return_results('Data successfully posted to XSIAM')

        # Log exceptions and return errors
        except Exception as e:
            return_error(f'Failed to execute {command} command.\nError:\n{str(e)}')


    ''' ENTRY POINT '''

    if __name__ in ('__main__', '__builtin__', 'builtins'):
        main()

    register_module_line('XQLHTTPCollector', 'end', __line__())
  type: python
  commands:
  - name: xql-post-to-dataset
    arguments:
    - name: JSON
      required: true
      isArray: true
  dockerimage: demisto/python3:3.10.9.42476
  runonce: false
  subtype: python3
sourcemoduleid: XQL HTTP Collector
